name: My Self-Hosted Workflow

on: [push]

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python venv (Rosetta if macOS ARM)
        run: |
          if [[ "$(uname)" == "Darwin" && "$(uname -m)" == "arm64" ]]; then
            echo "Apple Silicon detected â€” running under Rosetta"
            arch -x86_64 /usr/bin/python3 -m venv gh-runner
            source gh-runner/bin/activate
            arch -x86_64 python -m pip install --upgrade pip setuptools wheel
            echo "PYTHON_CMD=arch -x86_64 python" >> $GITHUB_ENV
          else
            python3 -m venv gh-runner
            source gh-runner/bin/activate
            python -m pip install --upgrade pip setuptools wheel
            echo "PYTHON_CMD=python" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: |
          source gh-runner/bin/activate
          $PYTHON_CMD -m pip install -r requirements.txt

      - name: Run tests
        run: |
          source gh-runner/bin/activate
          $PYTHON_CMD -m pytest --junit-xml=report.xml
